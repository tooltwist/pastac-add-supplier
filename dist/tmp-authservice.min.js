var authservice=function(){function e(e){return"bob"==e?L:null}function t(e,t,r,a,i){var n=b+t;if(console.log("authservice_ajax_call(method, "+t+")"),console.log(n),console.log(r),console.log("vvvvvv calling vvvvvv"),x){console.log("*** Using Angular AJAX call");x({method:"POST",url:n,data:r}).then(function(e){var t=e.data;return console.log("success:",t),a(t)},function(e){var t=e.status,r=e.statusText,n=e.data;return i?i(t,r,n):(alert("An error occurred contacting Authservice.\nSee the Javascript console for details."),console.log("statusCode:",e),console.log("statusText:",r),console.log("error:",n),a(null))})}else{console.log("*** Using jQuery AJAX call");var o=JSON.stringify(r);$.ajax({url:n,type:"POST",crossDomain:!0,async:!0,data:o,dataType:"json",contentType:"application/json",success:function(e){return a(e)},error:function(e,t,r){var n=e.status,o=e.statusText,s=r;return i?i(n,o,s):(alert("An error occurred contacting Authservice.\nSee the Javascript console for details."),console.log("statusCode:",n),console.log("statusText:",o),console.log("error:",s),a(null))}})}}function r(e){var t=RegExp("[?&]"+e+"=([^&]*)").exec(window.location.search);return t&&decodeURIComponent(t[1].replace(/\+/g," "))}function a(){var e=r("AUTHSERVICE_JWT");if(e){var t=!1;return void c(e,t)}var e=h(k);if(e){console.log("FOUND JWT IN A COOKIE");var t=!1;return void c(e,t)}var t=!0;u(null,null,t)}function i(){if(S){var e={user:{id:S.id,fullname:S.fullname,avatar:S.avatar,firstname:S.firstname,lastname:S.lastname},ttuat:P};v(k,JSON.stringify(e),T)}else v(k,null,0)}function n(){return S}function o(){return S?S.id:0}function s(){return P}function u(e,t,r){if(e){if(S=e,R=e.id,t&&(P=t),i(),$(".authservice-logged-in").show(),$(".authservice-logged-out").hide(),$(".authservice-current-user-firstname").text(e.firstname),$(".authservice-current-user-lastname").text(e.lastname),e.avatar?($(".authservice-current-user-avatar").attr("src",e.avatar).show(),$(".authservice-default-user-avatar").attr("src",e.avatar).hide()):($(".authservice-current-user-avatar").attr("src",e.avatar).hide(),$(".authservice-default-user-avatar").attr("src",e.avatar).show()),O){var a=n(),o=P;O(a,o,r)}}else if(S=null,R=-1,P=null,i(),$(".authservice-logged-in").hide(),$(".authservice-logged-out").show(),$(".authservice-current-user-firstname").text(""),$(".authservice-current-user-lastname").text(""),$(".authservice-current-user-avatar").attr("src","").hide(),O){var r=!1;O(null,null,r)}}function c(e,t){var r=!1;if(e)try{var a=jwt_decode(e);console.log(a);var i=a.identity;r=!0}catch(e){alert("Error decoding invalid JWT"),r=!1}if(r){var o={authority:i.authority,avatar:i.avatar,email:i.email,entityType:i.entity_type,firstname:i.first_name,fullname:i.full_name,gender:i.gender,id:i.id,isAdmin:i.is_admin,languages:i.languages,lastname:i.last_name,locale:i.locale,location:i.location,mediaPage:i.media_page,middlename:i.middle_name,privileges:i.privileges,status:i.status,timezone:i.timezone};if(console.log("Setting _currentUser to ",o),S=o,R=i.id,P=e,_jwt=e,v(k,e,T),$(".authservice-logged-in").show(),$(".authservice-logged-out").hide(),$(".authservice-current-user-firstname").text(o.firstname),$(".authservice-current-user-lastname").text(o.lastname),o.avatar?($(".authservice-current-user-avatar").attr("src",o.avatar).show(),$(".authservice-default-user-avatar").attr("src",o.avatar).hide()):($(".authservice-current-user-avatar").attr("src",o.avatar).hide(),$(".authservice-default-user-avatar").attr("src",o.avatar).show()),O){var s=n();O(s,P,t)}}else if(S=null,R=-1,P=null,_jwt=null,v(k,null,0),$(".authservice-logged-in").hide(),$(".authservice-logged-out").show(),$(".authservice-current-user-firstname").text(""),$(".authservice-current-user-lastname").text(""),$(".authservice-current-user-avatar").attr("src","").hide(),O){var t=!1;O(null,null,t)}}function v(e,t,r){console.log("setCookie("+e+")");var a=new Date;a.setTime(a.getTime()+24*r*60*60*1e3);var i="expires="+a.toUTCString();document.cookie=e+"="+t+";"+i+";path=/"}function h(e){for(var t=e+"=",r=document.cookie.split(";"),a=0;a<r.length;a++){for(var i=r[a];" "==i.charAt(0);)i=i.substring(1);if(0==i.indexOf(t))return i.substring(t.length,i.length)}return""}function g(e){var t={id:e.id,authority:e.authority,avatar:e.avatar,fullname:e.full_name,status:e.status,type:e.type};return"user"==t.type&&(t.locale=e.user.locale,t.location=e.user.location,t.timezone=e.user.timezone,t.firstname=e.user.user_first_name,t.gender=e.user.user_gender,t.languages=e.user.user_languages,t.lastname=e.user.user_last_name,t.mediaPage=e.user.user_media_page,t.middlename=e.user.user_middle_name),t.properties=e.properties,t.propertySummary=e.propertySummary,t.relationships=e.relationships,t.relationshipSummary=e.relationshipSummary,t}function d(e){if("string"==typeof e)var t=e,r=null,a=null;else var t=e.authority,r=e.successURL?e.successURL:null,a=e.failURL?e.failURL:null;if(!t)return void alert("authservice.initiateOAuth2(): missing 'authority' parameter");r||(r=p()),a||(a=r),console.log("successURL="+r),console.log("successURL="+encodeURIComponent(r)),console.log("failURL="+a);var i="http://"+_+":"+y+"/v2/oauth2/initiate/"+U+"/"+t;i+="?success="+encodeURIComponent(r),i+="&fail="+encodeURIComponent(a),window.location=i}function f(){return u(null,null,!1),authservice.resetLoginMenu(),!1}function m(e,r,a,i,n){if(A)return console.log("seems we are pretending"),i();if(null==e||e.indexOf("@")<1)return n("Please enter a valid email address");var o={email:e,username:e};if(C){if(null==a||a.length<5)return n("Please enter a longer password");o.password=a}console.log("params=",o),t("POST","/email/register",o,function(e){if(console.log("response is ",e),"ok"==e.status){if(console.log("Back from register:",e),i)return i()}else if(n)return n(e.error)})}function p(){l=window.location;var e=l.search;return""!=e&&(e="&"+e.substring(1),""!=(e=e.replace(/&AUTHSERVICE_JWT=[^&]*/,"").replace(/&AUTHSERVICE_ERROR=[^&]*/,""))&&(e="?"+e.substring(1))),l.protocol+"//"+l.host+l.pathname+e+l.hash}var _,y,w,U,k="authservice-login-details",T=3,b=null,R=-1,S=null,P=null,x=null,A=!1,C=!1,O=null,L={tenant:"nodeclient",id:901,authority:"email",type:"user",external_id:"jim",status:"new",email:"Bob",email_status:"",full_name:"Bob the Builder",avatar:"",entity_type_description:"User",is_login_account:1,user:{locale:"",location:"",timezone:"",user_first_name:"Bob",user_gender:"male",user_languages:"EN",user_last_name:"Builder",user_media_page:"",user_middle_name:"B"},relationshipSummary:{isFriendedBy:[{entity_id:902,full_name:"Jim Boots",last_name:"Boots",entity_type:"user"}],hasFriend:[{entity_id:903,full_name:"Jill Jones",last_name:"Jones",entity_type:"user"}]},relationships:[{relationship_id:6,relationship_type:"friend",entity_id_1:901,entity_id_2:902}]};return{register:m,logout:f,setCookie:v,getCookie:h,getCurrentUser:n,getCurrentUserId:o,getUserAccessToken:s,initiateOAuth2:d,init:function(e){console.log("authservice.init()",e),_=e.host?e.host:"authservice.io",y=e.port?e.port:80,w=e.version?e.version:"v1",U=e.tenant,b="//"+_+":"+y+"/"+w+"/"+U,e.$http&&(x=e.$http),e.onUserChange&&(O=e.onUserChange),A=!!e.pretend,C=!!e.registerWithPassword,a(),$("#authservice-login-button").click(function(){return $("#authservice-login-div").show(),$("#authservice-forgot-div").hide(),$("#authservice-register-div").hide(),!1}),$("#authservice-forgot-button").click(function(){return $("#authservice-login-button").hide(),$("#authservice-login-div").hide(),$("#authservice-forgot-div").show(),$("#authservice-register-button").hide(),$("#authservice-register-div").hide(),!1}),$("#authservice-register-button").click(function(){return $("#authservice-login-button").hide(),$("#authservice-login-div").hide(),$("#authservice-forgot-button").hide(),$("#authservice-forgot-div").hide(),$("#authservice-register-div").show(),!1}),$("#authservice-forgot-cancel").click(authservice.resetLoginMenu),$("#authservice-forgot-ok").click(authservice.resetLoginMenu),$("#authservice-register-cancel").click(authservice.resetLoginMenu),$("#authservice-register-ok").click(authservice.resetLoginMenu),$("#authservice-logout-button").click(function(){authservice.logout()}),$("#authservice-login-submit").click(function(){var e=$("#authservice-login-username").val(),t=$("#authservice-login-password").val();authservice.login(e,t,function(e){authservice.resetLoginMenu()},function(){$("#authservice-login-errmsg").show()})}),$("#authservice-forgot-submit").click(function(){var e=$("#authservice-forgot-username").val();alert("forgot("+e+")");var t=!1;return"ok"==e&&(t=!0),t?($("#authservice-forgot-email2").val(e),$("#authservice-forgot-button").hide(),$("#authservice-forgot-div").hide(),$("#authservice-forgot-done").show(),!1):($("#authservice-forgot-errmsg").show(),!1)}),$("#authservice-register-submit").click(function(){var e=($("#authservice-register-username").val(),$("#authservice-register-password").val()),t=!1;return"ok"==e&&(t=!0),t?($("#authservice-register-button").hide(),$("#authservice-register-div").hide(),$("#authservice-register-done").show(),!1):($("#authservice-register-errmsg").show(),!1)})},login:function(r,a,i,n){if(A){console.log("seems we are pretending");var o=e(r);return u(o,null,!1),i(o)}t("POST","/login",{username:r,password:a},function(e){if("ok"==e.status){if(console.log("Back from login:",e),c(e.jwt,!1),i)return i(S)}else if(n)return n(e.message)},function(e,t,r){if(console.log("Login failed: ",e,t,r),n)return n(t)})},reloadUser:function(r){if(console.log("reloadUser"),null==S){var a=null,i=null,n=!1;u(a,i,n),r&&r(null)}if(A){console.log("reloading dummy data");var a=e(S.username),i=null;return u(a,i,!1),r(a)}t("POST","/getIdentityWithAuthtoken",{ttuat:P,needRelationships:!0,needProperties:!0},function(e){if(console.log("back from /getIdentityWithAuthtoken ",e),e&&e.length>0){console.log("User details reloaded.");var t=g(e[0]),a=P,i=!1;u(t,a,i),r&&r(t)}else console.log("Could not reload user. Must have timed out."),u(null,null,i),r&&r(null)},function(e,t,a){console.log("Was not able to reload the user:",e,t,console.error),u(null,null,n),r&&r(null)})},resetLoginMenu:function(){return $("#authservice-login-button").show(),$("#authservice-login-div").show(),$("#authservice-forgot-button").show(),$("#authservice-forgot-div").hide(),$("#authservice-forgot-ok").hide(),$("#authservice-register-button").show(),$("#authservice-register-div").hide(),$("#authservice-register-ok").hide(),$("#authservice-login-username").val(""),$("#authservice-login-password").val(""),$("#authservice-forgot-username").val(""),$("#authservice-register-username").val(""),$("#authservice-register-password").val(""),$("#authservice-user-dropdown").parent().removeClass("open"),!0},getUser:function(e,r){console.log("getUser()"),t("POST","/admin/getUser",e,r)},addRelationship:function(e,r){console.log("addRelationship()"),t("POST","/admin/addRelationship",e,r)},removeRelationship:function(e,r){console.log("removeRelationship()"),t("POST","/admin/removeRelationship",e,r)},addProperty:function(e,r){console.log("addProperty()"),t("POST","/admin/addProperty",e,r)},removeProperty:function(e,r){console.log("removeProperty()"),t("POST","/admin/removeProperty",e,r)},nocomma:null}}();